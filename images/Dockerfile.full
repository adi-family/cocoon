# Cocoon - Full (Everything)
# Size: ~500MB | Use: Complete multi-language development environment
# Tools: Rust, Go, Python, Node.js, Docker CLI, kubectl, terraform, and more
#
# Build: docker buildx bake full
# Run:   docker run -e SIGNALING_SERVER_URL=wss://... git.the-ihor.com/adi/cocoon:full

# =============================================================================
# Stage 1: Build cocoon binary
# =============================================================================
FROM rust:1.85-alpine AS builder

RUN apk add --no-cache musl-dev openssl-dev openssl-libs-static pkgconfig

WORKDIR /build

COPY crates/lib/lib-tarminal-sync ./lib-tarminal-sync
COPY crates/lib/lib-plugin-abi ./lib-plugin-abi
COPY crates/cocoon/Cargo.toml ./Cargo.toml
COPY crates/cocoon/src ./src

RUN sed -i 's|path = "../lib/lib-tarminal-sync"|path = "./lib-tarminal-sync"|g' Cargo.toml && \
    sed -i 's|path = "../lib/lib-plugin-abi"|path = "./lib-plugin-abi"|g' Cargo.toml

RUN cd lib-plugin-abi && \
    sed -i 's|version.workspace = true|version = "0.1.0"|g' Cargo.toml && \
    sed -i 's|edition.workspace = true|edition = "2021"|g' Cargo.toml && \
    sed -i 's|authors.workspace = true|authors = ["ADI Team"]|g' Cargo.toml && \
    sed -i 's|abi_stable.workspace = true|abi_stable = "0.11"|g' Cargo.toml

RUN cargo build --release --features standalone

# =============================================================================
# Stage 2: Runtime (Full)
# =============================================================================
FROM ubuntu:24.04

LABEL org.opencontainers.image.title="Cocoon Full"
LABEL org.opencontainers.image.description="Complete multi-language containerized development environment"
LABEL cocoon.variant="full"
LABEL cocoon.tools="rust,go,python,node,docker-cli,kubectl,terraform,git,vim,tmux"

ENV DEBIAN_FRONTEND=noninteractive

# Install base system tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core utilities
    ca-certificates \
    curl \
    wget \
    git \
    git-lfs \
    jq \
    yq \
    tar \
    gzip \
    unzip \
    zip \
    xz-utils \
    # Build tools
    build-essential \
    pkg-config \
    cmake \
    ninja-build \
    clang \
    llvm \
    # Python
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    # Editors & tools
    vim \
    neovim \
    nano \
    less \
    htop \
    tree \
    tmux \
    screen \
    fzf \
    ripgrep \
    fd-find \
    bat \
    # Network tools
    openssh-client \
    rsync \
    netcat-openbsd \
    dnsutils \
    iputils-ping \
    # System
    sudo \
    locales \
    tzdata \
    gnupg \
    lsb-release \
    software-properties-common \
    apt-transport-https \
    # Shell
    bash \
    bash-completion \
    zsh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Setup locale
RUN locale-gen en_US.UTF-8

# Install Node.js 22 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g yarn pnpm typescript ts-node tsx && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Bun
RUN curl -fsSL https://bun.sh/install | bash
ENV PATH="/root/.bun/bin:$PATH"

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:$PATH"

# Install Go
RUN curl -fsSL https://go.dev/dl/go1.23.4.linux-amd64.tar.gz | tar -C /usr/local -xzf -
ENV PATH="/usr/local/go/bin:/root/go/bin:$PATH"

# Install Docker CLI (for docker-in-docker or socket mounting)
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && apt-get install -y docker-ce-cli docker-compose-plugin && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install kubectl
RUN curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /usr/share/keyrings/kubernetes-apt-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /" > /etc/apt/sources.list.d/kubernetes.list && \
    apt-get update && apt-get install -y kubectl && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Terraform
RUN curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list && \
    apt-get update && apt-get install -y terraform && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && apt-get install -y gh && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Python tools
RUN pip3 install --no-cache-dir --break-system-packages \
    virtualenv \
    poetry \
    uv \
    pipx \
    black \
    ruff \
    mypy \
    pytest \
    ipython \
    httpx \
    rich

# Copy cocoon binary
COPY --from=builder /build/target/release/cocoon /usr/local/bin/cocoon

# Setup workspace
RUN mkdir -p /cocoon/workspace /cocoon/output
WORKDIR /cocoon/workspace

# Create non-root user with sudo
RUN useradd -m -s /bin/bash -G sudo cocoon && \
    echo "cocoon ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    chown -R cocoon:cocoon /cocoon

# Environment
ENV SIGNALING_SERVER_URL=ws://signaling:8080/ws
ENV COCOON_VARIANT=full
ENV TERM=xterm-256color
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TZ=UTC
ENV EDITOR=vim

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD pgrep cocoon || exit 1

CMD ["/usr/local/bin/cocoon"]
